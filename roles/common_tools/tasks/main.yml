---
- name: Enable CentOS-Stream-CRB
  action: shell dnf config-manager --set-enabled crb
  when: releasever == 9 or releasever == 10

- name: Install basic tools
  package:
    name: "{{ item }}"
    state: latest
  with_items:
    - git
    - make
    - libseccomp-devel
    - postfix
    - acl
    - gcc-c++

- name: Install Fedora packages
  package:
    name: "{{ item }}"
    state: latest
  with_items:
    - golang-github-cpuguy83-md2man
    - openssl
    - s-nail
    - podman
    - podman-docker
    - pciutils
    - python3
    - python3-pytest
    - python3-pip
  when: releasever > 30

- name: Install CentOS Stream 9 packages
  package:
    name: "{{ item }}"
    state: latest
    validate_certs: no
    disable_gpg_check: true
  with_items:
    - https://kojihub.stream.centos.org/kojifiles/packages/golang-github-cpuguy83-md2man/2.0.0/16.gitaf8da76.el9/x86_64/golang-github-cpuguy83-md2man-2.0.0-16.gitaf8da76.el9.x86_64.rpm
    - s-nail
    - podman
    - podman-docker
    - python3.12
    - python3.12-pytest
    - python3.12-pip
  when: releasever == 9

- name: Install CentOS Stream 10 packages
  package:
    name: "{{ item }}"
    state: latest
    validate_certs: no
    disable_gpg_check: true
  with_items:
    - https://kojihub.stream.centos.org/kojifiles/vol/koji02/packages/golang-github-cpuguy83-md2man/2.0.3/3.el10/x86_64/golang-github-cpuguy83-md2man-2.0.3-3.el10.x86_64.rpm
    - s-nail
    - podman
    - podman-docker
    - python3.12
    - python3.12-pytest
    - python3.12-pip
  when: releasever == 10

- name: Create dir /etc/containers
  file:
    path: /etc/containers
    state: directory
    owner: root
    group: root
  when: releasever > 7

- name: ensure file /etc/containers/nodocker exists
  file:
    path: /etc/containers/nodocker
    state: touch
    mode: 0644
  when: releasever > 7

- name: Install container-ci-suite for tests
  pip:
    name: git+https://github.com/sclorg/container-ci-suite
    executable: pip3.12
  when: releasever == 9 or releasever == 10

- name: Install container-ci-suite for tests
  pip:
    name: git+https://github.com/sclorg/container-ci-suite
    executable: pip3
  when: releasever > 30